name: Build & Deploy

on:
  push:
    branches: [main]

jobs: 
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Clone Portfolio to Digital Ocean
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }} # IP address of the server you wish to ssh into
        key: ${{ secrets.SSH_KEY }} # Private or public key of the server
        username: ${{ secrets.SSH_USERNAME }} # User of the server you want to ssh into
        script: |
          set -euo pipefail

          # Load shell/env (DO droplets often need this for nvm)
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm install 18
          nvm use 18
          echo "ğŸŸ¢ Node: $(node -v)"
          echo "ğŸŸ¢ NPM:  $(npm -v)"

          cd /var/www/html/portfolio

          echo "ğŸ“¥ Updating repo..."
          git fetch origin
          git reset --hard origin/main

          echo "ğŸ§¹ Cleaning build artifacts and node_modules..."
          rm -rf .nuxt .output dist node_modules

          echo "ğŸ¨ Ensuring Sass setup (avoid sass-embedded issues in prod)..."
          # Will be handled by fresh install

          echo "ğŸ“¦ Installing dependencies (fresh install)..."
          npm install --legacy-peer-deps

          echo "ğŸ”¨ Generating static site..."
          NODE_ENV=production npm run generate || {
            echo "âŒ Generate failed, checking for errors..."
            exit 1
          }

          echo "âœ… Deploy complete."
